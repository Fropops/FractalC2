@page "/task-result/{AgentId}/{TaskId}"
@using WebCommander.Models
@using WebCommander.Services
@inject AgentService AgentService
@inject NavigationManager NavigationManager

<PageTitle>Task Result</PageTitle>

<div class="terminal-container">
    @if (task == null || result == null)
    {
        <p>Task or result not found</p>
    }
    else
    {
        <div class="terminal-header">
            <h4>ðŸ“‹ Task Result - @task.Command</h4>
            <button class="btn btn-sm btn-secondary" @onclick="Close">Close</button>
        </div>
        
        <div class="terminal-output">
            @foreach (var line in outputLines)
            {
                <div class="terminal-line @GetLineClass(line.Type)">@line.Text</div>
            }
        </div>
    }
</div>

<style>
    .terminal-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Courier New', monospace;
    }

    .terminal-header {
        background-color: #2d2d30;
        padding: 10px 20px;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .terminal-header h4 {
        margin: 0;
        color: #d4d4d4;
        font-size: 16px;
    }

    .terminal-output {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        font-size: 14px;
        line-height: 1.5;
    }

    .terminal-line {
        margin-bottom: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .terminal-line.error {
        color: #f48771;
    }

    .terminal-line.warning {
        color: #dcdcaa;
    }

    .terminal-line.info {
        color: #4ec9b0;
    }

    .terminal-line.normal {
        color: #d4d4d4;
    }

    .terminal-output::-webkit-scrollbar {
        width: 10px;
    }

    .terminal-output::-webkit-scrollbar-track {
        background: #1e1e1e;
    }

    .terminal-output::-webkit-scrollbar-thumb {
        background: #3e3e42;
        border-radius: 5px;
    }

    .terminal-output::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

@code {
    public enum TerminalLineType
    {
        Normal,
        Error,
        Warning,
        Info
    }

    public class TerminalLine
    {
        public string Text { get; set; } = string.Empty;
        public TerminalLineType Type { get; set; } = TerminalLineType.Normal;
    }

    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    [Parameter]
    public string TaskId { get; set; } = string.Empty;

    private TeamServerAgentTask? task;
    private AgentTaskResult? result;
    private List<TerminalLine> outputLines = new();

    protected override void OnInitialized()
    {
        task = AgentService.GetTasks().FirstOrDefault(t => t.Id == TaskId);
        result = AgentService.GetTaskResult(TaskId);
        
        if (task != null && result != null)
        {
            // Display header
            AddInfo($"Task {task.Command} is {result.Status}");
            AddInfo("-------------------------------------------");
            AddNormal("");
            
            // Display task info
            AddInfo($"Task ID: {task.Id}");
            AddInfo($"Agent ID: {task.AgentId}");
            AddInfo($"Request Date: {task.RequestDate.ToLocalTime()}");
            AddNormal("");
            
            // Display result
            if (!string.IsNullOrEmpty(result.Output))
            {
                AddNormal(result.Output);
            }
            if (!string.IsNullOrEmpty(result.Error))
            {
                AddError(result.Error);
            }
            if (!string.IsNullOrEmpty(result.Info))
            {
                AddInfo(result.Info);
            }
        }
    }

    private void AddNormal(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Normal });
    }

    private void AddError(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Error });
    }

    private void AddWarning(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Warning });
    }

    private void AddInfo(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Info });
    }

    private string GetLineClass(TerminalLineType type)
    {
        return type switch
        {
            TerminalLineType.Error => "error",
            TerminalLineType.Warning => "warning",
            TerminalLineType.Info => "info",
            _ => "normal"
        };
    }

    private void Close()
    {
        NavigationManager.NavigateTo($"/agent-tasks/{AgentId}");
    }
}
