@page "/task-result/{AgentId}/{TaskId}"
@using WebCommander.Models
@using WebCommander.Services
@inject AgentService AgentService
@inject NavigationManager NavigationManager

<PageTitle>Task Result</PageTitle>

<div class="terminal-container">
    @if (task == null || result == null)
    {
        <p>Task or result not found</p>
    }
    else
    {
        <div class="terminal-header">
            <h4>ðŸ“‹ Task Result - @task.Command</h4>
            <button class="btn btn-sm btn-secondary" @onclick="Close">Close</button>
        </div>
        
        <div class="terminal-output">
            @foreach (var line in outputLines)
            {
                <div class="terminal-line @GetLineClass(line.Type)">@line.Text</div>
            }
        </div>
    }
</div>

<style>
    .terminal-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Courier New', monospace;
    }

    .terminal-header {
        background-color: #2d2d30;
        padding: 10px 20px;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .terminal-header h4 {
        margin: 0;
        color: #d4d4d4;
        font-size: 16px;
    }

    .terminal-output {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        font-size: 14px;
        line-height: 1.5;
    }

    .terminal-line {
        margin-bottom: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .terminal-line.error {
        color: #f48771;
    }

    .terminal-line.warning {
        color: #dcdcaa;
    }

    .terminal-line.info {
        color: #4ec9b0;
    }

    .terminal-line.normal {
        color: #d4d4d4;
    }

    .terminal-output::-webkit-scrollbar {
        width: 10px;
    }

    .terminal-output::-webkit-scrollbar-track {
        background: #1e1e1e;
    }

    .terminal-output::-webkit-scrollbar-thumb {
        background: #3e3e42;
        border-radius: 5px;
    }

    .terminal-output::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

@using WebCommander.Models.ResultObjects
@using WebCommander.Helpers

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    [Parameter]
    public string TaskId { get; set; } = string.Empty;

    private TeamServerAgentTask? task;
    private AgentTaskResult? result;
    private List<TerminalLine> outputLines = new();

    protected override async Task OnInitializedAsync()
    {
        task = AgentService.GetTasks().FirstOrDefault(t => t.Id == TaskId);
        result = AgentService.GetTaskResult(TaskId);
        
        if (task != null && result != null)
        {
            // Display header
            AddInfo($"Task {task.Command} is {result.Status}");
            AddInfo("-------------------------------------------");
            AddNormal("");
            
            // Display task info
            AddInfo($"Task ID: {task.Id}");
            AddInfo($"Agent ID: {task.AgentId}");
            AddInfo($"Request Date: {task.RequestDate.ToLocalTime()}");
            AddNormal("");
            
            // Check if this is an ls command with Objects data
            if ((task.Command.StartsWith("ls") || task.Command.StartsWith("dir")) && result.Objects != null && result.Objects.Length > 0)
            {
                try
                {
                    var listResults = await ResultObjectHelper.DeserializeListDirectoryResults(result.Objects);
                    if (listResults.Count > 0)
                    {
                        // Add table output
                        AddLsTable(listResults);
                    }
                    else if (!string.IsNullOrEmpty(result.Output))
                    {
                        AddNormal(result.Output);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[TaskResultViewer] Error deserializing ls results: {ex.Message}");
                    // Fallback to normal output
                    if (!string.IsNullOrEmpty(result.Output))
                    {
                        AddNormal(result.Output);
                    }
                }
            }

            // Check if this is a ps command with Objects data
            else if ((task.Command.StartsWith("ps") || task.Command.StartsWith("powerpick")) && result.Objects != null && result.Objects.Length > 0)
            {
                try
                {
                    var processResults = await ResultObjectHelper.DeserializeListProcessResults(result.Objects);
                    if (processResults.Count > 0)
                    {
                        // Add process tree output
                        AddPsTable(processResults);
                    }
                    else if (!string.IsNullOrEmpty(result.Output))
                    {
                        AddNormal(result.Output);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[TaskResultViewer] Error deserializing ps results: {ex.Message}");
                    // Fallback to normal output
                    if (!string.IsNullOrEmpty(result.Output))
                    {
                        AddNormal(result.Output);
                    }
                }
            }
            else if (!string.IsNullOrEmpty(result.Output))
            {
                AddNormal(result.Output);
            }

            if (!string.IsNullOrEmpty(result.Error))
            {
                AddError(result.Error);
            }
            if (!string.IsNullOrEmpty(result.Info))
            {
                AddInfo(result.Info);
            }
        }
    }

    private void AddLsTable(List<ListDirectoryResult> items)
    {
        // Add table header
        var header = string.Format("{0,-10} {1,-15} {2}", "Type", "Size", "Name");
        AddInfo(header);
        AddInfo(new string('-', 80));
        
        // Add each item
        foreach (var item in items)
        {
            var type = item.IsFile ? "[FILE]" : "[DIR] ";
            var size = item.IsFile ? ResultObjectHelper.FormatFileSize(item.Length) : "";
            var line = string.Format("{0,-10} {1,-15} {2}", type, size, item.Name);
            AddNormal(line);
        }
    }

    private void AddPsTable(List<ListProcessResult> processes)
    {
        // Add table header
        var header = string.Format("{0,-6} {1,-6} {2,-30} {3,-10} {4,-20} {5}", "PID", "PPID", "Name", "Arch", "Owner", "Session");
        AddInfo(header);
        AddInfo(new string('-', 100));
        
        // Build process tree
        var processDict = processes.ToDictionary(p => p.Id, p => p);
        var rootProcesses = processes.Where(p => !processDict.ContainsKey(p.ParentId)).OrderBy(p => p.Id).ToList();
        
        // Render tree
        foreach (var rootProcess in rootProcesses)
        {
            AddProcessTreeNode(rootProcess, processDict, 0);
        }
    }

    private void AddProcessTreeNode(ListProcessResult process, Dictionary<int, ListProcessResult> processDict, int depth)
    {
        var indent = new string(' ', depth * 2);
        var maxNameLength = 30;
        var indentedName = indent + process.Name;
        
        if (indentedName.Length > maxNameLength)
        {
            indentedName = indentedName.Substring(0, maxNameLength);
        }

        var lineText = string.Format("{0,-6} {1,-6} {2,-30} {3,-10} {4,-20} {5}", 
            process.Id, 
            process.ParentId, 
            indentedName,
            process.Arch ?? "",
            process.Owner ?? "",
            process.SessionId);
        
        AddNormal(lineText);

        // Add children
        var children = processDict.Values.Where(p => p.ParentId == process.Id).OrderBy(p => p.Id).ToList();
        foreach (var child in children)
        {
            AddProcessTreeNode(child, processDict, depth + 1);
        }
    }

    private void AddNormal(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Normal });
    }

    private void AddError(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Error });
    }

    private void AddWarning(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Warning });
    }

    private void AddInfo(string text)
    {
        outputLines.Add(new TerminalLine { Text = text, Type = TerminalLineType.Info });
    }

    private string GetLineClass(TerminalLineType type)
    {
        return type switch
        {
            TerminalLineType.Error => "error",
            TerminalLineType.Warning => "warning",
            TerminalLineType.Info => "info",
            _ => "normal"
        };
    }

    private void Close()
    {
        NavigationManager.NavigateTo($"/agent-tasks/{AgentId}");
    }
}
