@page "/"
@using WebCommander.Models
@using WebCommander.Services
@using WebCommander.Helpers
@using WebCommander.Components
@inject AgentService AgentService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<div class="dashboard-container">
    <h1 class="mb-4">
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>

    <div class="row g-3 mb-4">
        <!-- Agents Tile -->
        <div class="col-md-4">
            <div class="dashboard-card agents-card" @onclick="NavigateToAgents">
                <div class="card-icon">
                    <i class="bi bi-laptop"></i>
                </div>
                <div class="card-content">
                    <h3>Agents</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value active">@activeAgents</span>
                            <span class="stat-label">Active</span>
                        </div>
                        <div class="stat-divider"></div>
                        <div class="stat-item">
                            <span class="stat-value inactive">@inactiveAgents</span>
                            <span class="stat-label">Inactive</span>
                        </div>
                    </div>
                    <div class="total-count">
                        Total: <strong>@totalAgents</strong>
                    </div>
                </div>
                <div class="card-arrow">
                    <i class="bi bi-arrow-right-circle"></i>
                </div>
            </div>
        </div>

        <!-- Listeners Tile -->
        <div class="col-md-4">
            <div class="dashboard-card listeners-card" @onclick="NavigateToListeners">
                <div class="card-icon">
                    <i class="bi bi-broadcast-pin"></i>
                </div>
                <div class="card-content">
                    <h3>Listeners</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value running">@runningListeners</span>
                            <span class="stat-label">Running</span>
                        </div>
                    </div>
                    <div class="total-count">
                        Total: <strong>@totalListeners</strong>
                    </div>
                </div>
                <div class="card-arrow">
                    <i class="bi bi-arrow-right-circle"></i>
                </div>
            </div>
        </div>

        <!-- Implants Tile -->
        <div class="col-md-4">
            <div class="dashboard-card implants-card" @onclick="NavigateToImplants">
                <div class="card-icon">
                    <i class="bi bi-file-earmark-binary"></i>
                </div>
                <div class="card-content">
                    <h3>Implants</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value available">@totalImplants</span>
                            <span class="stat-label">Available</span>
                        </div>
                    </div>
                    <div class="total-count">
                        Total: <strong>@totalImplants</strong>
                    </div>
                </div>
                <div class="card-arrow">
                    <i class="bi bi-arrow-right-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Topology Diagram -->
    <div class="row">
        <div class="col-12" style="min-width: 0;">
            <div class="card" style="width: 100%; overflow: hidden;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3"></i> Agent Topology
                    </h5>
                </div>
                <div class="card-body p-0" style="height: 70vh; position: relative;">
                    <AgentTopologyDiagram />
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        padding: 2rem;
    }

    .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        min-height: 160px;
        position: relative;
        overflow: hidden;
    }

    .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0);
        transition: all 0.3s ease;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .dashboard-card:hover::before {
        background: rgba(255, 255, 255, 0.1);
    }

    .agents-card {
        background: linear-gradient(135deg, #050A14 0%, #001233 100%);
        border: 1px solid #00d2ff;
    }

    .listeners-card {
        background: linear-gradient(135deg, #001233 0%, #003366 100%);
        border: 1px solid #00a0c4;
    }

    .implants-card {
        background: linear-gradient(135deg, #003366 0%, #005580 100%);
        border: 1px solid #00809d;
    }

    .card-icon {
        font-size: 4rem;
        opacity: 0.9;
        flex-shrink: 0;
    }

    .card-content {
        flex: 1;
        z-index: 1;
    }

    .card-content h3 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .stat-value.active {
        color: #4ade80;
    }

    .stat-value.inactive {
        color: #fbbf24;
    }

    .stat-value.running {
        color: #4ade80;
    }

    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .stat-divider {
        width: 2px;
        height: 40px;
        background: rgba(255, 255, 255, 0.3);
    }

    .total-count {
        font-size: 1rem;
        opacity: 0.9;
    }

    .card-arrow {
        font-size: 2rem;
        opacity: 0.7;
        transition: all 0.3s ease;
        z-index: 1;
    }

    .dashboard-card:hover .card-arrow {
        opacity: 1;
        transform: translateX(5px);
    }

    @@media (max-width: 768px) {
        .dashboard-card {
            flex-direction: column;
            text-align: center;
        }

        .card-icon {
            font-size: 3rem;
        }

        .stats {
            justify-content: center;
        }
    }
</style>

@code {
    private int totalAgents = 0;
    private int activeAgents = 0;
    private int inactiveAgents = 0;
    private int totalListeners = 0;
    private int runningListeners = 0;
    private int totalImplants = 0;

    protected override void OnInitialized()
    {
        // Subscribe to updates
        AgentService.OnAgentsUpdated += UpdateStats;
        AgentService.OnListenersUpdated += UpdateStats;
        AgentService.OnImplantsUpdated += UpdateStats;

        // Initial stats
        UpdateStats();
    }

    private void UpdateStats()
    {
        var agents = AgentService.GetAgents();
        totalAgents = agents.Count;
        activeAgents = agents.Count(a => AgentHelper.IsAgentAlive(a, agents) == true);
        inactiveAgents = totalAgents - activeAgents;

        var listeners = AgentService.GetListeners();
        totalListeners = listeners.Count;
        runningListeners = listeners.Count; // All listeners in the list are running

        var implants = AgentService.GetImplants();
        totalImplants = implants.Count;

        InvokeAsync(StateHasChanged);
    }

    private void NavigateToAgents()
    {
        Navigation.NavigateTo("/agents");
    }

    private void NavigateToListeners()
    {
        Navigation.NavigateTo("/listeners");
    }

    private void NavigateToImplants()
    {
        Navigation.NavigateTo("/implants");
    }

    public void Dispose()
    {
        AgentService.OnAgentsUpdated -= UpdateStats;
        AgentService.OnListenersUpdated -= UpdateStats;
    }
}
