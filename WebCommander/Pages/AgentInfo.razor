@page "/agent-info/{AgentId}"
@using WebCommander.Models
@using WebCommander.Services
@using WebCommander.Helpers
@using WebCommander.Components
@inject AgentService AgentService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Agent Info - @(agent?.Metadata?.ImplantId ?? "Unknown")</PageTitle>

@if (agent == null)
{
    <p>Agent not found</p>
}
else
{
    <div class="container-fluid">
        <AgentHeader Agent="@agent" ActivePage="info" />

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Detailed Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Agent Information</h6>
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 150px;">Agent ID:</td>
                                    <td>@agent.Id</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Implant:</td>
                                    <td>@agent.Metadata?.ImplantId</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Description:</td>
                                    <td>@agent.Metadata?.Desc</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Version:</td>
                                    <td>@agent.Metadata?.Version</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">System Information</h6>
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 150px;">Hostname:</td>
                                    <td>@agent.Metadata?.Hostname</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">IP Address:</td>
                                    <td>@AgentHelper.IpAsString(agent.Metadata?.Address)</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Architecture:</td>
                                    <td>@agent.Metadata?.Architecture</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr />

                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Process Information</h6>
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 150px;">Process Name:</td>
                                    <td>@agent.Metadata?.ProcessName</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Process ID:</td>
                                    <td>@agent.Metadata?.ProcessId</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">User:</td>
                                    <td>@agent.Metadata?.UserName</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Integrity:</td>
                                    <td>@agent.Metadata?.Integrity</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Connection Information</h6>
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 150px;">Endpoint:</td>
                                    <td>@agent.Metadata?.EndPoint</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Sleep Interval:</td>
                                    <td>@agent.Metadata?.SleepInterval seconds</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Last Seen:</td>
                                    <td>@agent.LastSeen.ToString("yyyy-MM-dd HH:mm:ss") UTC (@AgentHelper.FormatElapsedTime((DateTime.UtcNow - agent.LastSeen).TotalSeconds) ago)</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Status:</td>
                                    <td>
                                        @if (AgentHelper.IsAgentAlive(agent, AgentService.GetAgents()) ?? false)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    private Agent? agent;
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        RefreshAgent();
        AgentService.OnAgentsUpdated += RefreshAgent;
        
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    private void RefreshAgent()
    {
        agent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        InvokeAsync(StateHasChanged);
    }

    private void InteractWithAgent()
    {
        NavigationManager.NavigateTo($"/terminal/{AgentId}");
    }

    private void Close()
    {
        NavigationManager.NavigateTo("/agents");
    }

    public void Dispose()
    {
        AgentService.OnAgentsUpdated -= RefreshAgent;
        _timer?.Dispose();
    }
}
