@page "/agents"
@using WebCommander.Models
@using WebCommander.Services
@using WebCommander.Helpers
@inject AgentService AgentService
@implements IDisposable

@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<PageTitle>Agents</PageTitle>

<h1>Agents</h1>

@if (agents == null)
{
    <p><em>Loading...</em></p>
}
else if (agents.Count == 0)
{
    <p><em>No agents available yet.</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Implant</th>
                <th>Active</th>
                <th>User</th>
                <th>Host</th>
                <th>Address</th>
                <th>Integrity</th>
                <th>Process</th>
                <th>Arch.</th>
                <th>End Point</th>
                <th>Last Seen</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var agent in agents)
            {
                var isActive = AgentHelper.IsAgentAlive(agent, agents) ?? false;
                <tr class="@(isActive ? "" : "table-secondary")">
                    <td>@agent.Id</td>
                    <td>@agent.Metadata?.ImplantId</td>
                    <td>@(isActive ? "Yes" : "No")</td>
                    <td>@agent.Metadata?.UserName</td>
                    <td>@agent.Metadata?.Hostname</td>
                    <td>@AgentHelper.IpAsString(agent.Metadata?.Address)</td>
                    <td>@agent.Metadata?.Integrity</td>
                    <td>@agent.Metadata?.ProcessName (@agent.Metadata?.ProcessId)</td>
                    <td>@agent.Metadata?.Architecture</td>
                    <td>
                        @{
                            var endpoint = agent.Metadata?.EndPoint ?? "";
                            var connexion = ConnexionUrl.FromString(endpoint);
                            var modeIcon = connexion.IsValid && connexion.Mode == ConnexionMode.Listener 
                                ? "bi-arrow-left-circle text-success" 
                                : "bi-arrow-right-circle text-primary";
                            var modeTitle = connexion.IsValid && connexion.Mode == ConnexionMode.Listener 
                                ? "Listener" 
                                : "Client";
                        }
                        <i class="bi @modeIcon me-1" title="@modeTitle"></i>@endpoint
                    </td>
                    <td>@AgentHelper.FormatElapsedTime((DateTime.UtcNow - agent.LastSeen).TotalSeconds)</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" @onclick="() => ShowInfo(agent)">
                            <i class="bi bi-info-circle"></i> Infos
                        </button>
                        <button class="btn btn-sm btn-success me-1" @onclick="() => ShowTasks(agent)">
                            <i class="bi bi-list-task"></i> Tasks
                        </button>
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => ShowLoots(agent)">
                            <i class="bi bi-folder2-open"></i> Loots
                        </button>
                        @if (isActive)
                        {
                            <button class="btn btn-sm btn-primary" @onclick="() => InteractWithAgent(agent)">
                                <i class="bi bi-chat-dots"></i> Interact
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteAgent(agent)">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Agent> agents = new();
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        // Subscribe to agent updates
        AgentService.OnAgentsUpdated += OnAgentsUpdated;
        
        // Get initial agents
        agents = AgentService.GetAgents();
        
        // Start timer to update LastSeen every second
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void OnAgentsUpdated()
    {
        agents = AgentService.GetAgents();
        InvokeAsync(StateHasChanged);
    }

    private void ShowInfo(Agent agent)
    {
        NavigationManager.NavigateTo($"/agent-info/{agent.Id}");
    }

    private void ShowTasks(Agent agent)
    {
        NavigationManager.NavigateTo($"/agent-tasks/{agent.Id}");
    }

    private void ShowLoots(Agent agent)
    {
        NavigationManager.NavigateTo($"/loots/{agent.Id}");
    }

    private void InteractWithAgent(Agent agent)
    {
        NavigationManager.NavigateTo($"/terminal/{agent.Id}");
    }

    private async Task DeleteAgent(Agent agent)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete agent {agent.Metadata?.ImplantId ?? "Unknown"}?"))
        {
            await AgentService.StopAgentAsync(agent.Id);
        }
    }

    public void Dispose()
    {
        AgentService.OnAgentsUpdated -= OnAgentsUpdated;
        _timer?.Dispose();
    }
}
