@page "/agent-tasks/{AgentId}"
@using WebCommander.Models
@using WebCommander.Models.ResultObjects
@using WebCommander.Services
@using WebCommander.Helpers
@using WebCommander.Components
@inject AgentService AgentService
@inject ToastService ToastService
@inject TeamServerClient TeamServerClient
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Tasks - @(agent?.Metadata?.Name ?? "Unknown")</PageTitle>

@if (agent == null)
{
    <p>Agent not found</p>
}
else
{
    <div class="container-fluid">
        <AgentHeader Agent="@agent" ActivePage="tasks" />

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã Task History</h5>
            </div>
            <div class="card-body">
                @if (tasks.Count == 0)
                {
                    <p><em>No tasks found for this agent.</em></p>
                }
                else
                {
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in tasks)
                            {
                                var result = AgentService.GetTaskResult(task.Id);
                                var status = result?.Status ?? AgentResultStatus.Queued;
                                <tr>
                                    <td>@task.Id</td>
                                    <td>@task.RequestDate.ToLocalTime()</td>
                                    <td>@task.Command</td>
                                    <td>
                                        @switch (status)
                                        {
                                            case AgentResultStatus.Queued:
                                                <span title="Queued">‚è≥</span>
                                                break;
                                            case AgentResultStatus.Running:
                                                <span title="Running">‚ñ∂Ô∏è</span>
                                                break;
                                            case AgentResultStatus.Completed:
                                                <span title="Completed">‚úÖ</span>
                                                break;
                                            case AgentResultStatus.Error:
                                                <span title="Error">‚ùå</span>
                                                break;
                                        }
                                        @status.ToString()
                                    </td>
                                    <td>
                                        @if (status == AgentResultStatus.Completed || status == AgentResultStatus.Error)
                                        {
                                            <button class="btn btn-sm btn-secondary me-1" @onclick="() => ViewTaskResult(task.Id)">View Result</button>
                                            @if (result != null && (!string.IsNullOrEmpty(result.Output) || (result.Objects != null && result.Objects.Length > 0)))
                                            {
                                                <button class="btn btn-sm btn-warning" @onclick="() => AddToLoot(task.Id)">
                                                    <i class="bi bi-folder-plus"></i> Add to Loot
                                                </button>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    private Agent? agent;
    private List<TeamServerAgentTask> tasks = new();

    protected override void OnInitialized()
    {
        agent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        LoadTasks();
        
        AgentService.OnTasksUpdated += OnTasksUpdated;
        AgentService.OnAgentsUpdated += RefreshAgent;
    }

    private void RefreshAgent()
    {
        var updatedAgent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        if (updatedAgent != null)
        {
            agent = updatedAgent;
            InvokeAsync(StateHasChanged);
        }
    }

    private void LoadTasks()
    {
        tasks = AgentService.GetTasksForAgent(AgentId);
    }

    private void OnTasksUpdated()
    {
        LoadTasks();
        InvokeAsync(StateHasChanged);
    }

    private void ViewTaskResult(string taskId)
    {
        NavigationManager.NavigateTo($"/task-result/{AgentId}/{taskId}");
    }

    private async Task AddToLoot(string taskId)
    {
        var task = tasks.FirstOrDefault(t => t.Id == taskId);
        var result = AgentService.GetTaskResult(taskId);
        if (result == null || task == null) return;

        // Build file content with metadata header
        var header = new System.Text.StringBuilder();
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine("TASK OUTPUT");
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine();
        header.AppendLine($"Agent Name:      {agent?.Metadata?.Name ?? "Unknown"}");
        header.AppendLine($"Hostname:        {agent?.Metadata?.Hostname ?? "Unknown"}");
        header.AppendLine($"User:            {agent?.Metadata?.UserName ?? "Unknown"}");
        header.AppendLine($"IP Address:      {AgentHelper.IpAsString(agent?.Metadata?.Address)}");
        header.AppendLine($"Process:         {agent?.Metadata?.ProcessName ?? "Unknown"} (PID: {agent?.Metadata?.ProcessId})");
        header.AppendLine();
        header.AppendLine($"Task ID:         {taskId}");
        header.AppendLine($"Command:         {task.Command}");
        header.AppendLine($"Execution Date:  {task.RequestDate.ToLocalTime():yyyy-MM-dd HH:mm:ss}");
        header.AppendLine($"Status:          {result.Status}");
        header.AppendLine();
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine("OUTPUT");
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine();

        // Check if we need to format Objects data
        string outputContent = result.Output;
        
        if (string.IsNullOrEmpty(outputContent) && result.Objects != null && result.Objects.Length > 0)
        {
            // Try to deserialize as ps command
            if (task.Command.StartsWith("ps"))
            {
                try
                {
                    var processResults = await ResultObjectHelper.DeserializeListProcessResults(result.Objects);
                    if (processResults.Count > 0)
                    {
                        var sb = new System.Text.StringBuilder();
                        sb.AppendLine(string.Format("{0,-6} {1,-6} {2,-30} {3,-10} {4,-20} {5}", "PID", "PPID", "Name", "Arch", "Owner", "Session"));
                        sb.AppendLine(new string('-', 100));
                        
                        var processDict = processResults.ToDictionary(p => p.Id, p => p);
                        var rootProcesses = processResults.Where(p => !processDict.ContainsKey(p.ParentId)).OrderBy(p => p.Id).ToList();
                        
                        foreach (var rootProcess in rootProcesses)
                        {
                            AppendProcessTreeToLoot(sb, rootProcess, processDict, 0);
                        }
                        
                        outputContent = sb.ToString();
                    }
                }
                catch { }
            }
            // Try to deserialize as ls command
            else if (task.Command.StartsWith("ls") || task.Command.StartsWith("dir"))
            {
                try
                {
                    var listResult = await ResultObjectHelper.DeserializeListDirectoryResults(result.Objects);
                    if (listResult != null && listResult.Lines.Count > 0)
                    {
                        var sb = new System.Text.StringBuilder();
                        sb.AppendLine($"Directory: {listResult.Directory}");
                        sb.AppendLine();
                        sb.AppendLine(string.Format("{0,-10} {1,-15} {2}", "Type", "Size", "Name"));
                        sb.AppendLine(new string('-', 80));
                        
                        foreach (var item in listResult.Lines)
                        {
                            var type = item.IsFile ? "[FILE]" : "[DIR] ";
                            var size = item.IsFile ? ResultObjectHelper.FormatFileSize(item.Length) : "";
                            sb.AppendLine(string.Format("{0,-10} {1,-15} {2}", type, size, item.Name));
                        }
                        
                        outputContent = sb.ToString();
                    }
                }
                catch { }
            }
            // Try to deserialize as job command
            else if (task.Command.StartsWith("job"))
            {
                try
                {
                    var jobResults = await ResultObjectHelper.DeserializeJobResults(result.Objects);
                    if (jobResults.Count > 0)
                    {
                        var sb = new System.Text.StringBuilder();
                        sb.AppendLine(string.Format("{0,-6} {1,-15} {2,-20} {3,-10} {4}", "ID", "Type", "Name", "PID", "TaskID"));
                        sb.AppendLine(new string('-', 80));
                        
                        foreach (var job in jobResults)
                        {
                            var jobTypeStr = job.JobType.ToString().Length > 15 ? job.JobType.ToString().Substring(0, 15) : job.JobType.ToString();
                            var pidStr = job.ProcessId.HasValue ? job.ProcessId.Value.ToString() : "-";
                            sb.AppendLine(string.Format("{0,-6} {1,-15} {2,-20} {3,-10} {4}", 
                                job.Id, 
                                jobTypeStr, 
                                job.Name.Length > 20 ? job.Name.Substring(0, 17) + "..." : job.Name,
                                pidStr,
                                job.TaskId));
                        }
                        
                        outputContent = sb.ToString();
                    }
                }
                catch { }
            }
            // Try to deserialize as link command
            else if (task.Command.StartsWith("link"))
            {
                try
                {
                    var linkResults = await ResultObjectHelper.DeserializeLinkInfoResults(result.Objects);
                    if (linkResults.Count > 0)
                    {
                        var sb = new System.Text.StringBuilder();
                        sb.AppendLine(string.Format("{0,-20} {1,-20} {2,-20} {3}", "TaskID", "ParentID", "ChildID", "Binding"));
                        sb.AppendLine(new string('-', 100));
                        
                        foreach (var link in linkResults)
                        {
                            sb.AppendLine(string.Format("{0,-20} {1,-20} {2,-20} {3}", 
                                link.TaskId, 
                                link.ParentId, 
                                link.ChildId,
                                link.Binding));
                        }
                        
                        outputContent = sb.ToString();
                    }
                }
                catch { }
            }
        }

        header.Append(outputContent);

        var fileName = $"task_{taskId}.txt";
        var fileContent = System.Text.Encoding.UTF8.GetBytes(header.ToString());
        var base64Data = Convert.ToBase64String(fileContent);

        var loot = new Loot
        {
            AgentId = AgentId,
            FileName = fileName,
            Data = base64Data,
            IsImage = false
        };

        try
        {
            var success = await TeamServerClient.CreateLootAsync(AgentId, loot);
            if (success)
            {
                ToastService.ShowSuccess($"Task output saved as {fileName}", "Loot Added");
            }
            else
            {
                ToastService.ShowError("Failed to add loot", "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error adding loot: {ex.Message}", "Error");
        }
    }

    private void AppendProcessTreeToLoot(System.Text.StringBuilder sb, ListProcessResult process, Dictionary<int, ListProcessResult> processDict, int depth)
    {
        var indent = new string(' ', depth * 2);
        var maxNameLength = 30;
        var indentedName = indent + process.Name;
        
        if (indentedName.Length > maxNameLength)
        {
            indentedName = indentedName.Substring(0, maxNameLength);
        }

        sb.AppendLine(string.Format("{0,-6} {1,-6} {2,-30} {3,-10} {4,-20} {5}", 
            process.Id, 
            process.ParentId, 
            indentedName,
            process.Arch ?? "",
            process.Owner ?? "",
            process.SessionId));

        // Add children
        var children = processDict.Values.Where(p => p.ParentId == process.Id).OrderBy(p => p.Id).ToList();
        foreach (var child in children)
        {
            AppendProcessTreeToLoot(sb, child, processDict, depth + 1);
        }
    }

    private void InteractWithAgent()
    {
        NavigationManager.NavigateTo($"/terminal/{AgentId}");
    }

    public void Dispose()
    {
        AgentService.OnTasksUpdated -= OnTasksUpdated;
        AgentService.OnAgentsUpdated -= RefreshAgent;
    }
}
