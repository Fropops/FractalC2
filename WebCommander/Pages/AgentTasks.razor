@page "/agent-tasks/{AgentId}"
@using WebCommander.Models
@using WebCommander.Services
@using WebCommander.Helpers
@using WebCommander.Components
@inject AgentService AgentService
@inject ToastService ToastService
@inject TeamServerClient TeamServerClient
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Tasks - @(agent?.Metadata?.ImplantId ?? "Unknown")</PageTitle>

@if (agent == null)
{
    <p>Agent not found</p>
}
else
{
    <div class="container-fluid">
        <AgentHeader Agent="@agent" ActivePage="tasks" />

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã Task History</h5>
            </div>
            <div class="card-body">
                @if (tasks.Count == 0)
                {
                    <p><em>No tasks found for this agent.</em></p>
                }
                else
                {
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in tasks)
                            {
                                var result = AgentService.GetTaskResult(task.Id);
                                var status = result?.Status ?? AgentResultStatus.Queued;
                                <tr>
                                    <td>@task.Id</td>
                                    <td>@task.RequestDate.ToLocalTime()</td>
                                    <td>@task.Command</td>
                                    <td>
                                        @switch (status)
                                        {
                                            case AgentResultStatus.Queued:
                                                <span title="Queued">‚è≥</span>
                                                break;
                                            case AgentResultStatus.Running:
                                                <span title="Running">‚ñ∂Ô∏è</span>
                                                break;
                                            case AgentResultStatus.Completed:
                                                <span title="Completed">‚úÖ</span>
                                                break;
                                            case AgentResultStatus.Error:
                                                <span title="Error">‚ùå</span>
                                                break;
                                        }
                                        @status.ToString()
                                    </td>
                                    <td>
                                        @if (status == AgentResultStatus.Completed || status == AgentResultStatus.Error)
                                        {
                                            <button class="btn btn-sm btn-secondary me-1" @onclick="() => ViewTaskResult(task.Id)">View Result</button>
                                            @if (result != null && !string.IsNullOrEmpty(result.Output))
                                            {
                                                <button class="btn btn-sm btn-warning" @onclick="() => AddToLoot(task.Id)">
                                                    <i class="bi bi-folder-plus"></i> Add to Loot
                                                </button>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string AgentId { get; set; } = string.Empty;

    private Agent? agent;
    private List<TeamServerAgentTask> tasks = new();

    protected override void OnInitialized()
    {
        agent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        LoadTasks();
        
        AgentService.OnTasksUpdated += OnTasksUpdated;
        AgentService.OnAgentsUpdated += RefreshAgent;
    }

    private void RefreshAgent()
    {
        var updatedAgent = AgentService.GetAgents().FirstOrDefault(a => a.Id == AgentId);
        if (updatedAgent != null)
        {
            agent = updatedAgent;
            InvokeAsync(StateHasChanged);
        }
    }

    private void LoadTasks()
    {
        tasks = AgentService.GetTasksForAgent(AgentId);
    }

    private void OnTasksUpdated()
    {
        LoadTasks();
        InvokeAsync(StateHasChanged);
    }

    private void ViewTaskResult(string taskId)
    {
        NavigationManager.NavigateTo($"/task-result/{AgentId}/{taskId}");
    }

    private async Task AddToLoot(string taskId)
    {
        var task = tasks.FirstOrDefault(t => t.Id == taskId);
        var result = AgentService.GetTaskResult(taskId);
        if (result == null || string.IsNullOrEmpty(result.Output) || task == null) return;

        // Build file content with metadata header
        var header = new System.Text.StringBuilder();
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine("TASK OUTPUT");
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine();
        header.AppendLine($"Agent ID:        {agent?.Metadata?.ImplantId ?? "Unknown"}");
        header.AppendLine($"Hostname:        {agent?.Metadata?.Hostname ?? "Unknown"}");
        header.AppendLine($"User:            {agent?.Metadata?.UserName ?? "Unknown"}");
        header.AppendLine($"IP Address:      {AgentHelper.IpAsString(agent?.Metadata?.Address)}");
        header.AppendLine($"Process:         {agent?.Metadata?.ProcessName ?? "Unknown"} (PID: {agent?.Metadata?.ProcessId})");
        header.AppendLine();
        header.AppendLine($"Task ID:         {taskId}");
        header.AppendLine($"Command:         {task.Command}");
        header.AppendLine($"Execution Date:  {task.RequestDate.ToLocalTime():yyyy-MM-dd HH:mm:ss}");
        header.AppendLine($"Status:          {result.Status}");
        header.AppendLine();
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine("OUTPUT");
        header.AppendLine("=".PadRight(80, '='));
        header.AppendLine();
        header.Append(result.Output);

        var fileName = $"task_{taskId}.txt";
        var fileContent = System.Text.Encoding.UTF8.GetBytes(header.ToString());
        var base64Data = Convert.ToBase64String(fileContent);

        var loot = new Loot
        {
            AgentId = AgentId,
            FileName = fileName,
            Data = base64Data,
            IsImage = false
        };

        try
        {
            var success = await TeamServerClient.CreateLootAsync(AgentId, loot);
            if (success)
            {
                ToastService.ShowSuccess($"Task output saved as {fileName}", "Loot Added");
            }
            else
            {
                ToastService.ShowError("Failed to add loot", "Error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error adding loot: {ex.Message}", "Error");
        }
    }

    private void InteractWithAgent()
    {
        NavigationManager.NavigateTo($"/terminal/{AgentId}");
    }

    public void Dispose()
    {
        AgentService.OnTasksUpdated -= OnTasksUpdated;
        AgentService.OnAgentsUpdated -= RefreshAgent;
    }
}
