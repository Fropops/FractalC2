@using WebCommander.Models
@using WebCommander.Services
@inject AgentService AgentService
@inject ToastService ToastService
@inject NavigationManager NavigationManager
@implements IDisposable

@foreach (var toast in toasts)
{
    var topPosition = 80 + (toasts.IndexOf(toast) * 90); // Stack toasts vertically
    <div class="toast-notification show" 
         style="top: @(topPosition)px; animation-delay: @(toast.Index * 0.1)s">
        <div class="toast-header @GetHeaderClass(toast.Type)">
            <strong class="me-auto">@toast.Title</strong>
            <button type="button" class="btn-close" @onclick="() => RemoveToast(toast)">Ã—</button>
        </div>
        <div class="toast-body">
            @((MarkupString)toast.Message)
            @if (toast.Agent != null)
            {
                <div class="mt-2 text-center">
                    <button class="btn btn-sm btn-primary" @onclick="() => InteractWithAgent(toast.Agent)">Interact</button>
                </div>
            }
        </div>
    </div>
}

<style>
    .toast-notification {
        position: fixed;
        right: 20px;
        min-width: 300px;
        background-color: white;
        border: 1px solid rgba(0,0,0,.1);
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        z-index: 1050;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.3s ease-in-out;
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .toast-header {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background-color: #d1ecf1;
        border-bottom: 1px solid rgba(0,0,0,.05);
        border-top-left-radius: calc(0.375rem - 1px);
        border-top-right-radius: calc(0.375rem - 1px);
    }

    .toast-header.success { background-color: #d4edda; color: #155724; }
    .toast-header.error { background-color: #f8d7da; color: #721c24; }
    .toast-header.warning { background-color: #fff3cd; color: #856404; }
    .toast-header.info { background-color: #d1ecf1; color: #0c5460; }

    .toast-body {
        padding: 0.75rem;
    }

    .btn-close {
        background: transparent;
        border: 0;
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        color: #000;
        opacity: .5;
        cursor: pointer;
        padding: 0;
        width: 1em;
        height: 1em;
        margin-left: auto;
    }

    .btn-close:hover {
        opacity: .75;
    }
</style>

@code {
    private class ToastItem
    {
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public ToastType Type { get; set; } = ToastType.Info;
        public Agent? Agent { get; set; }
        public int Index { get; set; }
        public System.Threading.Timer? Timer { get; set; }
    }

    private List<ToastItem> toasts = new();
    private int toastCounter = 0;

    protected override void OnInitialized()
    {
        AgentService.OnNewAgent += OnNewAgent;
        ToastService.OnShow += OnShowToast;
    }

    private void OnShowToast(ToastMessage message)
    {
        Console.WriteLine($"[NotificationToast] OnShowToast called: {message.Title} - {message.Message}");
        AddToast(message.Title, message.Message, message.Type);
    }

    private void OnNewAgent(Agent agent)
    {
        AddToast("ðŸŽ‰ New Agent", 
            $"<strong>Agent {agent.Metadata?.ImplantId ?? "Unknown"}</strong> just connected<br/><small>{agent.Metadata?.Desc}</small>", 
            ToastType.Info, 
            agent);
    }

    private void AddToast(string title, string message, ToastType type, Agent? agent = null)
    {
        Console.WriteLine($"[NotificationToast] AddToast called: {title}");
        var toast = new ToastItem
        {
            Title = title,
            Message = message,
            Type = type,
            Agent = agent,
            Index = toastCounter++
        };

        toasts.Add(toast);
        Console.WriteLine($"[NotificationToast] Total toasts: {toasts.Count}");
        StateHasChanged();

        // Auto-remove after 5 seconds (15 for agents)
        var duration = agent != null ? 15 : 5;
        toast.Timer = new System.Threading.Timer(_ =>
        {
            RemoveToast(toast);
        }, null, TimeSpan.FromSeconds(duration), Timeout.InfiniteTimeSpan);
    }

    private void RemoveToast(ToastItem toast)
    {
        InvokeAsync(() =>
        {
            toasts.Remove(toast);
            toast.Timer?.Dispose();
            StateHasChanged();
        });
    }

    private string GetHeaderClass(ToastType type)
    {
        return type.ToString().ToLower();
    }

    private void InteractWithAgent(Agent agent)
    {
        NavigationManager.NavigateTo($"/terminal/{agent.Id}");
    }

    public void Dispose()
    {
        AgentService.OnNewAgent -= OnNewAgent;
        ToastService.OnShow -= OnShowToast;
        foreach (var toast in toasts)
        {
            toast.Timer?.Dispose();
        }
    }
}
